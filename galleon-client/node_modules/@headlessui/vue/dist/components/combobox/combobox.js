import{Fragment as G,computed as g,defineComponent as A,h as _,inject as Q,nextTick as E,onMounted as q,onUnmounted as X,provide as Y,ref as w,toRaw as f,watch as J,watchEffect as K}from"vue";import{Features as N,render as F,omit as $,compact as Z}from'../../utils/render.js';import{useId as j}from'../../hooks/use-id.js';import{Keys as I}from'../../keyboard.js';import{calculateActiveIndex as z,Focus as T}from'../../utils/calculate-active-index.js';import{dom as P}from'../../utils/dom.js';import{useOpenClosed as ee,State as U,useOpenClosedProvider as te}from'../../internal/open-closed.js';import{match as M}from'../../utils/match.js';import{useResolveButtonType as oe}from'../../hooks/use-resolve-button-type.js';import{useTreeWalker as ne}from'../../hooks/use-tree-walker.js';import{sortByDomNode as ae}from'../../utils/focus-management.js';import{useOutsideClick as le}from'../../hooks/use-outside-click.js';import{Hidden as ie,Features as ue}from'../../internal/hidden.js';import{objectToFormEntries as re}from'../../utils/form.js';import{useControllable as se}from'../../hooks/use-controllable.js';function de(o,x){return o===x}var pe=(l=>(l[l.Open=0]="Open",l[l.Closed=1]="Closed",l))(pe||{}),be=(l=>(l[l.Single=0]="Single",l[l.Multi=1]="Multi",l))(be||{}),fe=(l=>(l[l.Pointer=0]="Pointer",l[l.Other=1]="Other",l))(fe||{});let W=Symbol("ComboboxContext");function L(o){let x=Q(W,null);if(x===null){let l=new Error(`<${o} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(l,L),l}return x}let Ae=A({name:"Combobox",emits:{"update:modelValue":o=>!0},props:{as:{type:[Object,String],default:"template"},disabled:{type:[Boolean],default:!1},by:{type:[String,Function],default:()=>de},modelValue:{type:[Object,String,Number,Boolean],default:void 0},defaultValue:{type:[Object,String,Number,Boolean],default:void 0},name:{type:String},nullable:{type:Boolean,default:!1},multiple:{type:[Boolean],default:!1}},inheritAttrs:!1,setup(o,{slots:x,attrs:l,emit:y}){let e=w(1),t=w(null),c=w(null),S=w(null),O=w(null),m=w({static:!1,hold:!1}),a=w([]),C=w(null),n=w(1),b=w(!1);function d(i=s=>s){let s=C.value!==null?a.value[C.value]:null,r=ae(i(a.value.slice()),v=>P(v.dataRef.domRef)),u=s?r.indexOf(s):null;return u===-1&&(u=null),{options:r,activeOptionIndex:u}}let R=g(()=>o.multiple?1:0),D=g(()=>o.nullable),[k,V]=se(g(()=>o.modelValue),i=>y("update:modelValue",i),g(()=>o.defaultValue)),p={comboboxState:e,value:k,mode:R,compare(i,s){if(typeof o.by=="string"){let r=o.by;return(i==null?void 0:i[r])===(s==null?void 0:s[r])}return o.by(i,s)},nullable:D,inputRef:c,labelRef:t,buttonRef:S,optionsRef:O,disabled:g(()=>o.disabled),options:a,change(i){V(i)},activeOptionIndex:g(()=>{if(b.value&&C.value===null&&a.value.length>0){let i=a.value.findIndex(s=>!s.dataRef.disabled);if(i!==-1)return i}return C.value}),activationTrigger:n,optionsPropsRef:m,closeCombobox(){b.value=!1,!o.disabled&&e.value!==1&&(e.value=1,C.value=null)},openCombobox(){if(b.value=!0,o.disabled||e.value===0)return;let i=a.value.findIndex(s=>{let r=f(s.dataRef.value);return M(R.value,{[0]:()=>p.compare(f(p.value.value),f(r)),[1]:()=>f(p.value.value).some(v=>p.compare(f(v),f(r)))})});i!==-1&&(C.value=i),e.value=0},goToOption(i,s,r){if(b.value=!1,o.disabled||O.value&&!m.value.static&&e.value===1)return;let u=d();if(u.activeOptionIndex===null){let h=u.options.findIndex(B=>!B.dataRef.disabled);h!==-1&&(u.activeOptionIndex=h)}let v=z(i===T.Specific?{focus:T.Specific,id:s}:{focus:i},{resolveItems:()=>u.options,resolveActiveIndex:()=>u.activeOptionIndex,resolveId:h=>h.id,resolveDisabled:h=>h.dataRef.disabled});C.value=v,n.value=r!=null?r:1,a.value=u.options},selectOption(i){let s=a.value.find(u=>u.id===i);if(!s)return;let{dataRef:r}=s;V(M(R.value,{[0]:()=>r.value,[1]:()=>{let u=f(p.value.value).slice(),v=f(r.value),h=u.findIndex(B=>p.compare(v,f(B)));return h===-1?u.push(v):u.splice(h,1),u}}))},selectActiveOption(){if(p.activeOptionIndex.value===null)return;let{dataRef:i,id:s}=a.value[p.activeOptionIndex.value];V(M(R.value,{[0]:()=>i.value,[1]:()=>{let r=f(p.value.value).slice(),u=f(i.value),v=r.findIndex(h=>p.compare(u,f(h)));return v===-1?r.push(u):r.splice(v,1),r}})),p.goToOption(T.Specific,s)},registerOption(i,s){let r={id:i,dataRef:s},u=d(v=>[...v,r]);if(C.value===null){let v=s.value.value;M(R.value,{[0]:()=>p.compare(f(p.value.value),f(v)),[1]:()=>f(p.value.value).some(B=>p.compare(f(B),f(v)))})&&(u.activeOptionIndex=u.options.indexOf(r))}a.value=u.options,C.value=u.activeOptionIndex,n.value=1},unregisterOption(i){let s=d(r=>{let u=r.findIndex(v=>v.id===i);return u!==-1&&r.splice(u,1),r});a.value=s.options,C.value=s.activeOptionIndex,n.value=1}};le([c,S,O],()=>p.closeCombobox(),g(()=>e.value===0)),Y(W,p),te(g(()=>M(e.value,{[0]:U.Open,[1]:U.Closed})));let H=g(()=>p.activeOptionIndex.value===null?null:a.value[p.activeOptionIndex.value].dataRef.value);return()=>{let{name:i,disabled:s,...r}=o,u={open:e.value===0,disabled:s,activeIndex:p.activeOptionIndex.value,activeOption:H.value,value:k.value};return _(G,[...i!=null&&k.value!=null?re({[i]:k.value}).map(([v,h])=>_(ie,Z({features:ue.Hidden,key:v,as:"input",type:"hidden",hidden:!0,readOnly:!0,name:v,value:h}))):[],F({theirProps:{...l,...$(r,["modelValue","defaultValue","nullable","multiple","onUpdate:modelValue","by"])},ourProps:{},slot:u,slots:x,attrs:l,name:"Combobox"})])}}}),Fe=A({name:"ComboboxLabel",props:{as:{type:[Object,String],default:"label"}},setup(o,{attrs:x,slots:l}){let y=L("ComboboxLabel"),e=`headlessui-combobox-label-${j()}`;function t(){var c;(c=P(y.inputRef))==null||c.focus({preventScroll:!0})}return()=>{let c={open:y.comboboxState.value===0,disabled:y.disabled.value},S={id:e,ref:y.labelRef,onClick:t};return F({ourProps:S,theirProps:o,slot:c,attrs:x,slots:l,name:"ComboboxLabel"})}}}),Le=A({name:"ComboboxButton",props:{as:{type:[Object,String],default:"button"}},setup(o,{attrs:x,slots:l,expose:y}){let e=L("ComboboxButton"),t=`headlessui-combobox-button-${j()}`;y({el:e.buttonRef,$el:e.buttonRef});function c(m){e.disabled.value||(e.comboboxState.value===0?e.closeCombobox():(m.preventDefault(),e.openCombobox()),E(()=>{var a;return(a=P(e.inputRef))==null?void 0:a.focus({preventScroll:!0})}))}function S(m){switch(m.key){case I.ArrowDown:m.preventDefault(),m.stopPropagation(),e.comboboxState.value===1&&e.openCombobox(),E(()=>{var a;return(a=e.inputRef.value)==null?void 0:a.focus({preventScroll:!0})});return;case I.ArrowUp:m.preventDefault(),m.stopPropagation(),e.comboboxState.value===1&&(e.openCombobox(),E(()=>{e.value.value||e.goToOption(T.Last)})),E(()=>{var a;return(a=e.inputRef.value)==null?void 0:a.focus({preventScroll:!0})});return;case I.Escape:if(e.comboboxState.value!==0)return;m.preventDefault(),e.optionsRef.value&&!e.optionsPropsRef.value.static&&m.stopPropagation(),e.closeCombobox(),E(()=>{var a;return(a=e.inputRef.value)==null?void 0:a.focus({preventScroll:!0})});return}}let O=oe(g(()=>({as:o.as,type:x.type})),e.buttonRef);return()=>{var n,b;let m={open:e.comboboxState.value===0,disabled:e.disabled.value,value:e.value.value},a={ref:e.buttonRef,id:t,type:O.value,tabindex:"-1","aria-haspopup":!0,"aria-controls":(n=P(e.optionsRef))==null?void 0:n.id,"aria-expanded":e.disabled.value?void 0:e.comboboxState.value===0,"aria-labelledby":e.labelRef.value?[(b=P(e.labelRef))==null?void 0:b.id,t].join(" "):void 0,disabled:e.disabled.value===!0?!0:void 0,onKeydown:S,onClick:c};return F({ourProps:a,theirProps:o,slot:m,attrs:x,slots:l,name:"ComboboxButton"})}}}),Be=A({name:"ComboboxInput",props:{as:{type:[Object,String],default:"input"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},displayValue:{type:Function}},emits:{change:o=>!0},setup(o,{emit:x,attrs:l,slots:y,expose:e}){let t=L("ComboboxInput"),c=`headlessui-combobox-input-${j()}`;e({el:t.inputRef,$el:t.inputRef});let S=w(t.value.value),O=()=>{var b;let n=t.value.value;return P(t.inputRef)?typeof o.displayValue!="undefined"?(b=o.displayValue(n))!=null?b:"":typeof n=="string"?n:"":""};q(()=>{J([t.value],()=>S.value=O(),{flush:"sync",immediate:!0}),J([S,t.comboboxState],([n,b],[d,R])=>{let D=P(t.inputRef);!D||(R===0&&b===1||n!==d)&&(D.value=n)},{immediate:!0})});function m(n){switch(n.key){case I.Backspace:case I.Delete:if(t.mode.value!==0||!t.nullable.value)return;let b=n.currentTarget;requestAnimationFrame(()=>{if(b.value===""){t.change(null);let d=P(t.optionsRef);d&&(d.scrollTop=0),t.goToOption(T.Nothing)}});break;case I.Enter:if(t.comboboxState.value!==0)return;if(n.preventDefault(),n.stopPropagation(),t.activeOptionIndex.value===null){t.closeCombobox();return}t.selectActiveOption(),t.mode.value===0&&t.closeCombobox();break;case I.ArrowDown:return n.preventDefault(),n.stopPropagation(),M(t.comboboxState.value,{[0]:()=>t.goToOption(T.Next),[1]:()=>t.openCombobox()});case I.ArrowUp:return n.preventDefault(),n.stopPropagation(),M(t.comboboxState.value,{[0]:()=>t.goToOption(T.Previous),[1]:()=>{t.openCombobox(),E(()=>{t.value.value||t.goToOption(T.Last)})}});case I.Home:case I.PageUp:return n.preventDefault(),n.stopPropagation(),t.goToOption(T.First);case I.End:case I.PageDown:return n.preventDefault(),n.stopPropagation(),t.goToOption(T.Last);case I.Escape:if(t.comboboxState.value!==0)return;n.preventDefault(),t.optionsRef.value&&!t.optionsPropsRef.value.static&&n.stopPropagation(),t.closeCombobox();break;case I.Tab:if(t.comboboxState.value!==0)return;t.mode.value===0&&t.selectActiveOption(),t.closeCombobox();break}}function a(n){x("change",n)}function C(n){t.openCombobox(),x("change",n)}return()=>{var R,D,k,V,p,H;let n={open:t.comboboxState.value===0},b={"aria-controls":(R=t.optionsRef.value)==null?void 0:R.id,"aria-expanded":t.disabled.value?void 0:t.comboboxState.value===0,"aria-activedescendant":t.activeOptionIndex.value===null||(D=t.options.value[t.activeOptionIndex.value])==null?void 0:D.id,"aria-multiselectable":t.mode.value===1?!0:void 0,"aria-labelledby":(p=(k=P(t.labelRef))==null?void 0:k.id)!=null?p:(V=P(t.buttonRef))==null?void 0:V.id,id:c,onKeydown:m,onChange:a,onInput:C,role:"combobox",type:(H=l.type)!=null?H:"text",tabIndex:0,ref:t.inputRef},d=$(o,["displayValue"]);return F({ourProps:b,theirProps:d,slot:n,attrs:l,slots:y,features:N.RenderStrategy|N.Static,name:"ComboboxInput"})}}}),je=A({name:"ComboboxOptions",props:{as:{type:[Object,String],default:"ul"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},hold:{type:[Boolean],default:!1}},setup(o,{attrs:x,slots:l,expose:y}){let e=L("ComboboxOptions"),t=`headlessui-combobox-options-${j()}`;y({el:e.optionsRef,$el:e.optionsRef}),K(()=>{e.optionsPropsRef.value.static=o.static}),K(()=>{e.optionsPropsRef.value.hold=o.hold});let c=ee(),S=g(()=>c!==null?c.value===U.Open:e.comboboxState.value===0);return ne({container:g(()=>P(e.optionsRef)),enabled:g(()=>e.comboboxState.value===0),accept(O){return O.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:O.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(O){O.setAttribute("role","none")}}),()=>{var C,n,b,d;let O={open:e.comboboxState.value===0},m={"aria-activedescendant":e.activeOptionIndex.value===null||(C=e.options.value[e.activeOptionIndex.value])==null?void 0:C.id,"aria-labelledby":(d=(n=P(e.labelRef))==null?void 0:n.id)!=null?d:(b=P(e.buttonRef))==null?void 0:b.id,id:t,ref:e.optionsRef,role:"listbox"},a=$(o,["hold"]);return F({ourProps:m,theirProps:a,slot:O,attrs:x,slots:l,features:N.RenderStrategy|N.Static,visible:S.value,name:"ComboboxOptions"})}}}),He=A({name:"ComboboxOption",props:{as:{type:[Object,String],default:"li"},value:{type:[Object,String,Number,Boolean]},disabled:{type:Boolean,default:!1}},setup(o,{slots:x,attrs:l,expose:y}){let e=L("ComboboxOption"),t=`headlessui-combobox-option-${j()}`,c=w(null);y({el:c,$el:c});let S=g(()=>e.activeOptionIndex.value!==null?e.options.value[e.activeOptionIndex.value].id===t:!1),O=g(()=>M(e.mode.value,{[0]:()=>e.compare(f(e.value.value),f(o.value)),[1]:()=>f(e.value.value).some(d=>e.compare(f(d),f(o.value)))})),m=g(()=>({disabled:o.disabled,value:o.value,domRef:c}));q(()=>e.registerOption(t,m)),X(()=>e.unregisterOption(t)),K(()=>{e.comboboxState.value===0&&(!S.value||e.activationTrigger.value!==0&&E(()=>{var d,R;return(R=(d=P(c))==null?void 0:d.scrollIntoView)==null?void 0:R.call(d,{block:"nearest"})}))});function a(d){if(o.disabled)return d.preventDefault();e.selectOption(t),e.mode.value===0&&e.closeCombobox()}function C(){if(o.disabled)return e.goToOption(T.Nothing);e.goToOption(T.Specific,t)}function n(){o.disabled||S.value||e.goToOption(T.Specific,t,0)}function b(){o.disabled||!S.value||e.optionsPropsRef.value.hold||e.goToOption(T.Nothing)}return()=>{let{disabled:d}=o,R={active:S.value,selected:O.value,disabled:d},D={id:t,ref:c,role:"option",tabIndex:d===!0?void 0:-1,"aria-disabled":d===!0?!0:void 0,"aria-selected":O.value,disabled:void 0,onClick:a,onFocus:C,onPointermove:n,onMousemove:n,onPointerleave:b,onMouseleave:b};return F({ourProps:D,theirProps:o,slot:R,attrs:l,slots:x,name:"ComboboxOption"})}}});export{Ae as Combobox,Le as ComboboxButton,Be as ComboboxInput,Fe as ComboboxLabel,He as ComboboxOption,je as ComboboxOptions};
